/*
DELETE 
FROM   IPTDW.IPTDW_RES_KPI_SUBSDR_CNTRY
WHERE  CAT_CD = 'BEP_SMART_BB'
;
*/

INSERT INTO IPTDW.IPTDW_RES_KPI_SUBSDR_CNTRY
(
   BASE_YYYYMM
  ,SCENARIO_TYPE_CD
  ,DIV_CD
  ,SUBSDR_CD
  ,AU_CD
  ,MANUAL_ADJ_FLAG
  ,KPI_CD
  ,CAT_CD
  ,SUB_CAT_CD
  ,ZONE_RNR_CD
  ,SUBSDR_RNR_CD
  ,CNTRY_CD
  ,APPLY_YYYYMM
  ,CURRM_USD_AMT
  ,ATTRIBUTE1_VALUE
  ,ATTRIBUTE2_VALUE
  ,CREATION_DATE
  ,CREATION_USR_ID
  ,LAST_UPD_DATE
  ,LAST_UPD_USR_ID
)
-- 1227
SELECT BAL.BASIS_YYYYMM AS BASE_YYYYMM
      ,'AC0' AS SCENARIO_TYPE_CD
      ,BAL.DIVISION_CODE AS DIV_CD
      ,BAL.CORPORATION_CODE AS SUBSDR_CD
      ,'*' AS AU_CD
      ,'N' AS MANUAL_ADJ_FLAG
      ,KPI.CODE AS KPI_CD
      ,'BEP_SMART_BB' AS CAT_CD
      ,'*' AS SUB_CAT_CD
      ,BAL.PRODUCT_LEVEL4_CODE AS ZONE_RNR_CD
      ,BAL.CORPORATION_NAME AS SUBSDR_RNR_CD
      ,'*' AS CNTRY_CD
      ,BAL.BASIS_YYYYWW AS APPLY_YYYYMM
      ,SUM(CASE KPI.CODE
                WHEN 'AWARD' THEN BAL.BEGINNING_AMT + BAL.NEW_AMT + BAL.INCREASE_AMT + BAL.DECREASE_AMT
                WHEN 'SALES' THEN BAL.CHANGE_AMT END ) AS CURRM_USD_AMT
      ,BAL.PRODUCT_LEVEL4_CODE
      ,BAL.CORPORATION_NAME
      ,CURRENT TIMESTAMP   
      ,'ares'              
      ,CURRENT TIMESTAMP   
      ,'ares'        
FROM   IPTDWIF.IPTDWIF_RES_B2B_PIPELINE_BALANCE BAL
      ,(SELECT 'AWARD' AS CODE FROM SYSIBM.SYSDUMMY1 UNION ALL
        SELECT 'SALES' AS CODE FROM SYSIBM.SYSDUMMY1) KPI
--WHERE  BAL.CORPORATION_CODE = 'EHAP'       
GROUP BY BAL.BASIS_YYYYMM
        ,BAL.DIVISION_CODE
        ,BAL.CORPORATION_CODE
        ,KPI.CODE
        ,BAL.BASIS_YYYYWW
        ,BAL.PRODUCT_LEVEL4_CODE
        ,BAL.CORPORATION_NAME        
;